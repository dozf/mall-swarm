### 注册中心
先启动 注册中心nacos-server (如：D:\soft\nacos-server-1.3.1\nacos\bin , 双击startup.cmd)。
查看Nacos控制台  
     通过浏览器访问 http://localhost:8848/nacos，即 Nacos Server 网址。 默认的账号密码为nacos/nacos
  
### 项目启动先后顺序
mall-swarm项目启动有先后顺序，大家可以按照以下顺序启动。
```
启动网关服务mall-gateway，直接运行MallGatewayApplication的main函数即可；

启动认证中心mall-auth，直接运行MallAuthApplication的main函数即可；

启动后台管理服务mall-admin，直接运行MallAdminApplication的main函数即可；
```
       
运行完成后可以直接通过如下地址访问API文档：http://localhost:8201/doc.html

### 测试
调用认证中心接口获取token
如何访问需要登录的接口，先调用认证中心接口(/oauth/token)获取token，后台管理client_id和client_secret为admin-app:123456，前台系统为portal-app:123456；


### 项目分析
#### mall-auth 认证项目
> 认证认证服务器配置  

com.macro.mall.auth.config.Oauth2ServerConfig.configure
配置了 admin-app 和 portal-app 两个client信息。用于区别mall-admin(后台管理项目)，mall-portal(前台商城项目)

> 加载用户信息  

com.macro.mall.auth.service.impl.UserServiceImpl.loadUserByUsername
会根据 client_id 分别取 mall-admin、mall-portal 调用用户信息接口

#### mall-gateway 网关项目
> 鉴权管理器，用于判断是否有资源的访问权限

    com.macro.mall.authorization.AuthorizationManager
    //管理端路径需校验权限(含资源与角色关系)
    Map<Object, Object> resourceRolesMap = redisTemplate.opsForHash().entries(AuthConstant.RESOURCE_ROLES_MAP_KEY);
    
> resourceRolesMap 的内部结构分析：

     resourceRolesMap.put("/api/hello", CollUtil.toList("1_ADMIN"));  //“1_ADMIN”表示， ums_role表的id_name
     resourceRolesMap.put("/api/user/currentUser", CollUtil.toList("1_ADMIN", "2_TEST"));

#### mall-admin 后台管理项目
> 后台管理登录接口

com.macro.mall.service.impl.UmsAdminServiceImpl.login，内部会调用认证中心接口(/oauth/token)获取token


#### mall-portal 前台商城项目
> 前台商城登录接口

com.macro.mall.portal.service.impl.UmsMemberServiceImpl.login，内部会调用认证中心接口(/oauth/token)获取token
     
### 参考：
[mall-swarm在Windows环境下的部署](http://www.macrozheng.com/#/deploy/mall_swarm_deploy_windows) 在项目的mall-swarm\document\reference\deploy_windows.md  
[微服务权限终极解决方案，Spring Cloud Gateway + Oauth2 实现统一认证和鉴权！](https://juejin.im/post/6850037263707930631)
